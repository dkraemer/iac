{
    "variables": {
        "dev_mode": "no",
        "source_vm_name": "base-ubuntu-18.04",
        "source_vm_attach_snapshot": "packing",
        "source_vm_target_snapshot": "packer-base",
        "source_vm_user": "ubuntu",
        "source_vm_password": "ubuntu",
        "vm_cleanup": "yes",
        "output_name_prefix": "base-",
        "output_name": "ubuntu-18.04"
    },
    "builders": [
        {
            "type": "virtualbox-vm",
            "communicator": "ssh",
            "name": "{{user `output_name_prefix`}}{{user `output_name`}}",
            "vm_name": "{{user `source_vm_name`}}",
            "attach_snapshot": "{{user `source_vm_attach_snapshot`}}",
            "target_snapshot": "{{user `source_vm_target_snapshot`}}",
            "shutdown_command": "sudo systemctl poweroff",
            "ssh_username": "{{user `source_vm_user`}}",
            "ssh_password": "{{user `source_vm_password`}}",
            "format": "ova",
            "skip_export": false,
            "headless": true,
            "force_delete_snapshot": false,
            "keep_registered": false,
            "output_directory": "output"
        }
    ],
    "provisioners": [
        {
            "type": "shell-local",
            "command": "tar -cvzf files.tar.gz files"
        },
        {
            "type": "file",
            "source": "files.tar.gz",
            "destination": "files.tar.gz",
            "generated": true
        },
        {
            "type": "shell",
            "environment_vars": [
                "DEV_MODE={{user `dev_mode`}}",
                "PASSWORD={{user `source_vm_password`}}",
                "CLEANUP={{user `vm_cleanup`}}"
            ],
            "script": "provision.sh",
            "expect_disconnect": true
        }
    ]
}